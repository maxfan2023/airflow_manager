#!/usr/bin/env bash

# ============================================================
# Environment config for airflow-manager.sh / celery-worker-manager.sh
# Environment: uat
# ============================================================

# Airflow base paths
export AIRFLOW_HOME="${AIRFLOW_HOME:-/opt/airflow}"
export PID_DIR="${PID_DIR:-$AIRFLOW_HOME/run/pids}"
export COMMON_LOGDIR="${COMMON_LOGDIR:-$AIRFLOW_HOME/logs}"
export MANAGER_LOG_DIR="${MANAGER_LOG_DIR:-$AIRFLOW_HOME/logs/manager}"
# Debug mode for manager scripts. When true, logs include command execution details.
export MANAGER_DEBUG="${MANAGER_DEBUG:-false}"

# Optional Conda activation before running service commands
export CONDA_BASE="${CONDA_BASE:-/opt/conda}"
export CONDA_ENV_NAME="${CONDA_ENV_NAME:-airflow-3.12}"

# UAT does not manage PostgreSQL lifecycle by default.
export MANAGE_POSTGRESQL_IN_THIS_ENV="${MANAGE_POSTGRESQL_IN_THIS_ENV:-false}"

# Redis settings
export REDIS_DIR="${REDIS_DIR:-/opt/redis}"
export REDIS_CONF="${REDIS_CONF:-$REDIS_DIR/redis.conf}"
export REDIS_HOST="${REDIS_HOST:-hkl25188264.hk.hsbc}"
export REDIS_PORT="${REDIS_PORT:-6379}"
export REDIS_AUTH="${REDIS_AUTH:-airflow123}"

# Airflow core services
export API_SERVER_PORT="${API_SERVER_PORT:-8181}"
export HOSTNAME_OVERRIDE="${HOSTNAME_OVERRIDE:-hkl25188264.hk.hsbc}"
export FLOWER_PORT="${FLOWER_PORT:-5555}"
# Optional override when process naming differs by platform/version:
# export API_SERVER_PATTERN="airflow[[:space:]]+api[-_]server"

# If SSL/TLS is enabled for Flower, keep this true to include --flower-conf.
export FLOWER_ENABLE_SSL="${FLOWER_ENABLE_SSL:-true}"
export FLOWER_CONF="${FLOWER_CONF:-$AIRFLOW_HOME/flower_config.py}"

# Celery worker defaults
export CELERY_WORKER="${CELERY_WORKER:-$(id -un)}"
export WORKER_NM="${WORKER_NM:-4}"
export WORKER_LOG_LEVEL="${WORKER_LOG_LEVEL:-INFO}"
export WORKER_QUEUE_PREFIX="${WORKER_QUEUE_PREFIX:-queue_worker_}"
export WORKER_APP="${WORKER_APP:-airflow.providers.celery.executors.celery_executor.app}"
# Queue behavior:
# - If WORKER_QUEUE_NAME is not set, queue defaults to "queue_worker_<worker>,default".
# - If WORKER_QUEUE_NAME is set, script still appends ",default" when missing.
# Optional override when worker process title/cmdline differs:
# export WORKER_PATTERN="airflow[[:space:]]+celery[[:space:]]+worker|celery([[:space:]]+-A[[:space:]]+${WORKER_APP})?[[:space:]]+worker|celeryd:.*celery worker"
# Optional override for worker-manager user filter:
# export WORKER_OS_UID="$(id -u)"

# Stop behavior
export STOP_WAIT_SECONDS="${STOP_WAIT_SECONDS:-10}"
export FORCE_KILL_WAIT_SECONDS="${FORCE_KILL_WAIT_SECONDS:-5}"

# Startup verification behavior (detect process exits right after launch).
export START_VERIFY_RETRIES="${START_VERIFY_RETRIES:-6}"
export START_VERIFY_INTERVAL_SECONDS="${START_VERIFY_INTERVAL_SECONDS:-1}"
